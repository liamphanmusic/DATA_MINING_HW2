---
title: "HOMEWORK 2 - Creating Value Through Data Mining (S402010)"
author: "Liam Phan"
date: "`r Sys.Date()`"
output:
  rmdformats::material :
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: true
    highlight: tango
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE)
rm(list = ls()) # clean environment
cat("\014") # clean console
```

# <span style="color: #1c6155;">Quick Start</span> 

## Loading Packages

```{r 1, warning=FALSE, message=FALSE }

library(data.table) # Efficient Dataframe 
library(lubridate) # For Dates 
library(tidyverse) # Multiple Package for Useful Data wrangling
library(esquisse) # Intuitive plotting
library(plyr) # Data splitting
library(dplyr)
library(ggplot2) # Plot Graphs
library(naniar) # for NA exploration in Dataframe
library(plotly) # Make ggplot2 Dynamic
library(DT) # Render Table in a explorable UI
library(gridExtra) # Multiple Plot at once
library(corrplot) # Correlation Plot
library(RColorBrewer) # For Color Palette
library(rmdformats) # Theme of HTML
library(manipulateWidget) # Handling multiple plotly graphs
library(caTools) # Split Training and Validation Sets
library(flextable) # Show Table
library(class) # K-NN

```

> Those are required packages

# <span style="color: #1c6155;">Exercise 1.</span> 

## 5.6 Evaluating Predictive Performance

### a. 

> If the company beings working with a new set of 1000 leads to sell the same services, similar to the 500 in the plot study, witout any use of predictive modeling to target sales efforts, what is the estimated profit? 

<br />

Without any predictive modeling, we can roughly estimated the profit with the following formula: 

$$ Profit_{Estimated} = 1000*\$2128 = \$2128000  $$

<br />

But the company will also have expenditures related to their sales, which would negatively impact the Total Profit. The sales effort would be:

$$ Costs_{Estimated} = 1000*\$2500 = \$2500000   $$

<br />

Leading to negative Total Profit of... 

$$ TotalProfit_{Estimated} = Profit_{Estimated} - Costs_{Estimated} \\ = \$2128000 - \$2500000 = - \$372000  $$

<br />

### b.

> If the firm wants the average profit on each sale to at least double the sales effort cost, and applies an appopriate cutoff with this predictive model to a new set of 1000 leads, how far down the new list of 1000 should it proceed (how many deciles)?

If we want to double the average profit on each sale, we should take the first decile (10%) on the Decile-wise lift chart which double the mean. 

$$ Ratio_{Estimated} = \dfrac{2*\$2500}{\$2128} = 2.35 $$

<br />

### c.

> Still considering the new list of 1000 leads, if the company applies this predictive model with a lower cutoff of $2500, how far should it proceed down the ranked leads, in terms of deciles?

We want the cutoff to be $2500: 

$$ Ratio_{Estimated} = \dfrac{\$2500}{\$2128} = 1.17 $$

If we take a look at the Decile-wise lift chart, we see that the 6th decile (approx mean-reponse of 1, same as 2128$)

<br />

### d. 

> Why use this two-stage process for predicting sales--why not simply develop a model for predicting profit for the 1000 new leads?

# <span style="color: #1c6155;">Exercise 2.</span> 

## 7.2 Personnal Loan Acceptance

### Loading Dataset and Basic Data Quality Check

Dimensions, Variables Count and Dataset Structure

```{r 2, echo=FALSE, warning=FALSE}

UniversalBank1 <- fread("DATA/UniversalBank.csv")

flextable(head(UniversalBank1)) %>% 
  fontsize(size = 7, part = "all")

dim(UniversalBank1)

sapply(UniversalBank1, function(x) length(unique(x)))

str(UniversalBank1)


```

<center>

Missing Variables Plot

```{r 3,echo=FALSE,warning=FALSE}

gg_miss_var(UniversalBank1, show_pct = TRUE)

```

No Missing Values

</center>

### Partition The Data Into Training (60%) and Validation (40%) Sets

```{r 4,echo=TRUE}

# Setting Seed
set.seed(1)

# Splitting Training and Validation 
sample <- sample(c(TRUE, FALSE), nrow(UniversalBank1), replace=TRUE, prob=c(0.6,0.4))
training  <- UniversalBank1[sample, ]
validation   <- UniversalBank1[!sample, ]

# Checking if proportions are right
train_prop <- dim(training)
validation_prop <- dim(validation)

train_prop_100 <- (train_prop[1]/nrow(UniversalBank1))*100
validation_prop_100 <- (validation_prop[1]/nrow(UniversalBank1))*100

paste(train_prop_100,"% In Training",validation_prop_100,"% In Validation")

``` 

### a. Considering the following customer: 

> Age = 40, Experience = 10, Income = 84, Family = 2, CCAvg = 2, Education_1 = 0, Education_2 = 1, Education_3 = 0, Mortgage = 0, Securities Account = 0, CD Account = 0, Online = 1, and Credit Card = 1. 

Perform a Κ-NN Classification with all predictors except ID and ZIP code using Κ = 1 

```{r 5, echo=TRUE, results='hide'}

# Removing Some Predictors
training <- training[,-c("ID","ZIP Code")]
validation <- validation[,-c("ID","ZIP Code")]

# Target Variable As Factor
training$`Personal Loan` <- as.factor(training$`Personal Loan`) 
validation$`Personal Loan` <- as.factor(validation$`Personal Loan`) 

# Education As Factor
training$Education <- as.factor(training$Education) 
validation$Education <- as.factor(validation$Education) 

# Education One-Hot Encoding
Education_As_Dummy_Training <- model.matrix(~0+training$Education)
Education_As_Dummy_Validation <- model.matrix(~0+validation$Education)

# Append to Training and Validation Sets
training <- cbind(training,Education_As_Dummy_Training)
training <- training[,-c("Education")]

validation <- cbind(validation,Education_As_Dummy_Validation)
validation <- validation[,-c("Education")]

# Renaming Education
training = training %>% rename( Education_1 = `training$Education1` , Education_2 = `training$Education2`, Education_3 = `training$Education3`)
validation = validation %>% rename( Education_1 = `validation$Education1` , Education_2 = `validation$Education2`, Education_3 = `validation$Education3`)

# KNN Model using class package
library(class)

# KNN Model on a specific customer not in Data
Customer_Test <- data.frame("Age"=40,"Experience"=10,"Income"=84,"Famiy"=2,"CCAvg"=2,"Mortgage"=0,"Securities Account"=0,"CD Account"=0,"Online"=1,"Credit Card"=1,"Education_1"=0,"Education_2"=1,"Education_3"=0, check.names=FALSE)

## KNN Training for Customer
predictions_customer <- knn(train=training[,-c("Personal Loan")],test = Customer_Test, cl = training$`Personal Loan`, k=1)

predictions_customer <- as.factor(predictions_customer)

levels(predictions_customer) <- c("Fail","Success")

# Append Predictions to Customer not in Data
Customer_Test$Predicted <- predictions_customer

# Correct Factors of previous Validation
levels(Customer_Test$Predicted) <- c("Fail","Success")

```

<center>

```{r 6, echo=TRUE}

# Table Customer after Predictions
flextable(head(Customer_Test)) %>% 
  fontsize(size = 7, part = "all")

```

</center>

> This Customer would be classified as not getting a Personnal Loan (Fail)

### b. What is the Choice of Κ that balances between overfitting and ignoring the predictor information?

```{r 7, echo=TRUE}

# Load Caret 
library(caret)

# Number of iterations
iterations = 20

# Dataframe with 2 columns: k and accuracy
accuracy.df <- data.frame(k=seq(1,iterations,1),accuracy=rep(0,iterations))

# Compute K-NN for different k on validation
for(i in 1:iterations){
  # Testing K-NN
  knn.prediction <- knn(train = training[,-c("Personal Loan")], test=validation[,-c("Personal Loan")] , cl=training$`Personal Loan`, k=iterations)
  # Storing into the accuracy.df results
  accuracy.df[i,2] <- confusionMatrix(knn.prediction, validation$`Personal Loan`)$overall[1]
}

# Table of Accuracy
flextable(accuracy.df) %>% 
  fontsize(size = 12, part = "all")

# Ploting the K and accuracy together
ggplot(accuracy.df) +
 aes(x = k, y = accuracy) +
 geom_line(size = 0.5, colour = "#112446") +
 labs(x = "Number of K", 
 y = "Accuracy (Between Training and Validation)", title = "K-NN Accuracy regarding parameter K") +
 theme_minimal()

# Choosing Efficient K
highest_K <- which.max(accuracy.df$accuracy)

print(paste("Best K for Highest Accuracy is",highest_K))

```

### c. Show the confusion matrix for the validation data that results from using best K

```{r 8, echo=TRUE}

# Computing Confusion Matrix with K=3
predictions_k3 <- knn(train=training[,-c("Personal Loan")],test = validation[,-c("Personal Loan")], cl = training$`Personal Loan`, k=3)

# As Factor Predictions
predictions_k3 <- as.factor(predictions_k3)

# Relabel 0 and 1 to "Success" and "Fail
levels(predictions_k3)<- c("Fail","Success")
levels(validation$`Personal Loan`) <- c("Fail","Success")

# Confusion Matrix
Confusion_Matrix_k3 <- confusionMatrix(data = predictions_k3, reference = validation$`Personal Loan`)

# Plot
draw_confusion_matrix <- function(cm) {

  layout(matrix(c(1,1,2)))
  par(mar=c(2,2,2,2))
  plot(c(100, 345), c(300, 450), type = "n", xlab="", ylab="", xaxt='n', yaxt='n')
  title('CONFUSION MATRIX', cex.main=2)

  # create the matrix 
  rect(150, 430, 240, 370, col='#1c6155')
  text(195, 435, 'Fail', cex=1.2)
  rect(250, 430, 340, 370, col='#77baae')
  text(295, 435, 'Success', cex=1.2)
  text(125, 370, 'Predicted', cex=1.3, srt=90, font=2)
  text(245, 450, 'Actual', cex=1.3, font=2)
  rect(150, 305, 240, 365, col='#77baae')
  rect(250, 305, 340, 365, col='#1c6155')
  text(140, 400, 'Fail', cex=1.2, srt=90)
  text(140, 335, 'Succes', cex=1.2, srt=90)

  # add in the cm results 
  res <- as.numeric(cm$table)
  text(195, 400, res[1], cex=1.6, font=2, col='white')
  text(195, 335, res[2], cex=1.6, font=2, col='white')
  text(295, 400, res[3], cex=1.6, font=2, col='white')
  text(295, 335, res[4], cex=1.6, font=2, col='white')

  # add in the specifics 
  plot(c(100, 0), c(100, 0), type = "n", xlab="", ylab="", main = "DETAILS", xaxt='n', yaxt='n')
  text(10, 85, names(cm$byClass[1]), cex=1.2, font=2)
  text(10, 70, round(as.numeric(cm$byClass[1]), 3), cex=1.2)
  text(30, 85, names(cm$byClass[2]), cex=1.2, font=2)
  text(30, 70, round(as.numeric(cm$byClass[2]), 3), cex=1.2)
  text(50, 85, names(cm$byClass[5]), cex=1.2, font=2)
  text(50, 70, round(as.numeric(cm$byClass[5]), 3), cex=1.2)
  text(70, 85, names(cm$byClass[6]), cex=1.2, font=2)
  text(70, 70, round(as.numeric(cm$byClass[6]), 3), cex=1.2)
  text(90, 85, names(cm$byClass[7]), cex=1.2, font=2)
  text(90, 70, round(as.numeric(cm$byClass[7]), 3), cex=1.2)

  # add in the accuracy information 
  text(30, 35, names(cm$overall[1]), cex=1.5, font=2)
  text(30, 20, round(as.numeric(cm$overall[1]), 3), cex=1.4)
  text(70, 35, names(cm$overall[2]), cex=1.5, font=2)
  text(70, 20, round(as.numeric(cm$overall[2]), 3), cex=1.4)
}  
draw_confusion_matrix(Confusion_Matrix_k3)

```

### d. Consider the following customer:

> Age = 40, Experience = 10, Income = 84, Family = 2, CCAvg = 2, Education_1 = 0, Education_2 = 1, Education_3 = 0, Mortgage = 0, Securities Account = 0, CD Account = 0, Online = 1, and Credit Card = 1. 

```{r 9, echo=TRUE}

# KNN Model on a specific customer not in Data
Customer_Test_2 <- data.frame("Age"=40,"Experience"=10,"Income"=84,"Famiy"=2,"CCAvg"=2,"Mortgage"=0,"Securities Account"=0,"CD Account"=0,"Online"=1,"Credit Card"=1,"Education_1"=0,"Education_2"=1,"Education_3"=0, check.names=FALSE)

## KNN Training for Customer
predictions_customer_2 <- knn(train=training[,-c("Personal Loan")],test = Customer_Test_2, cl = training$`Personal Loan`, k=highest_K)

predictions_customer_2 <- as.factor(predictions_customer_2)

# Append Predictions to Customer not in Data
Customer_Test_2$Predicted <- predictions_customer_2

```

```{r 10, echo=TRUE}

# Table Customer after Predictions
flextable(head(Customer_Test_2)) %>% 
  fontsize(size = 7, part = "all")

```


# <span style="color: #1c6155;">Exercise 3.</span>



# <span style="color: #1c6155;">References</span>

[Github Repo for this Homework 2](https://github.com/LiamPhan17/DATA_MINING_HW2)

[Data Mining for Business Analytics: Concepts, Techniques, and Applications in R](https://www.wiley.com/en-us/Data+Mining+for+Business+Analytics:+Concepts,+Techniques,+and+Applications+in+R-p-9781118879368)

[How to Split Data into Training & Test Sets in R (3 Methods)](https://www.statology.org/train-test-split-r/)