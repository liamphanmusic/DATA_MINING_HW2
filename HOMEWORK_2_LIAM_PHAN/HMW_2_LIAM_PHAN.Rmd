---
title: "HOMEWORK 2 - Creating Value Through Data Mining (S402010)"
author: "Liam Phan"
date: "`r Sys.Date()`"
output:
  rmdformats::material :
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: true
    highlight: tango
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE)
rm(list = ls()) # clean environment
cat("\014") # clean console
```

# <span style="color: #1c6155;">Quick Start</span> 

## Loading Packages

```{r 1, warning=FALSE, message=FALSE }

library(data.table) # Efficient Dataframe 
library(lubridate) # For Dates 
library(tidyverse) # Multiple Package for Useful Data wrangling
library(esquisse) # Intuitive plotting
library(plyr) # Data splitting
library(dplyr)
library(ggplot2) # Plot Graphs
library(naniar) # for NA exploration in Dataframe
library(plotly) # Make ggplot2 Dynamic
library(DT) # Render Table in a explorable UI
library(gridExtra) # Multiple Plot at once
library(corrplot) # Correlation Plot
library(RColorBrewer) # For Color Palette
library(rmdformats) # Theme of HTML
library(manipulateWidget) # Handling multiple plotly graphs
library(caTools) # Split Training and Validation Sets
library(flextable) # Show Table
library(class) # K-NN

```

> Those are required packages

# <span style="color: #1c6155;">Exercise 1.</span> 

## 5.6 Evaluating Predictive Performance

### a. 

> If the company beings working with a new set of 1000 leads to sell the same services, similar to the 500 in the plot study, witout any use of predictive modeling to target sales efforts, what is the estimated profit? 

<br />

Without any predictive modeling, we can roughly estimated the profit with the following formula: 

$$ Profit_{Estimated} = 1000*\$2128 = \$2128000  $$

<br />

But the company will also have expenditures related to their sales, which would negatively impact the Total Profit. The sales effort would be:

$$ Costs_{Estimated} = 1000*\$2500 = \$2500000   $$

<br />

Leading to negative Total Profit of... 

$$ TotalProfit_{Estimated} = Profit_{Estimated} - Costs_{Estimated} \\ = \$2128000 - \$2500000 = - \$372000  $$

<br />

### b.

> If the firm wants the average profit on each sale to at least double the sales effort cost, and applies an appopriate cutoff with this predictive model to a new set of 1000 leads, how far down the new list of 1000 should it proceed (how many deciles)?

If we want to double the average profit on each sale, we should take the first decile (10%) on the Decile-wise lift chart which double the mean. 

$$ Ratio_{Estimated} = \dfrac{2*\$2500}{\$2128} = 2.35 $$

<br />

### c.

> Still considering the new list of 1000 leads, if the company applies this predictive model with a lower cutoff of $2500, how far should it proceed down the ranked leads, in terms of deciles?

We want the cutoff to be $2500: 

$$ Ratio_{Estimated} = \dfrac{\$2500}{\$2128} = 1.17 $$

If we take a look at the Decile-wise lift chart, we see that the 6th decile (approx mean-reponse of 1, same as 2128$)

<br />

### d. 

> Why use this two-stage process for predicting sales--why not simply develop a model for predicting profit for the 1000 new leads?

# <span style="color: #1c6155;">Exercise 2.</span> 

## 7.2 Personnal Loan Acceptance

### Loading Dataset and Basic Data Quality Check

Dimensions, Variables Count and Dataset Structure

```{r 2, echo=FALSE, warning=FALSE}

UniversalBank1 <- fread("DATA/UniversalBank.csv")

flextable(head(UniversalBank1)) %>% 
  fontsize(size = 7, part = "all")

dim(UniversalBank1)

sapply(UniversalBank1, function(x) length(unique(x)))

str(UniversalBank1)


```

<center>

Missing Variables Plot

```{r 3,echo=FALSE,warning=FALSE}

gg_miss_var(UniversalBank1, show_pct = TRUE)

```

No Missing Values

</center>

### Partition The Data Into Training (60%) and Validation (40%) Sets

```{r 4,echo=TRUE}

# Setting Seed
set.seed(1)

# Splitting Training and Validation 
sample <- sample(c(TRUE, FALSE), nrow(UniversalBank1), replace=TRUE, prob=c(0.6,0.4))
training  <- UniversalBank1[sample, ]
validation   <- UniversalBank1[!sample, ]

# Checking if proportions are right
train_prop <- dim(training)
validation_prop <- dim(validation)

train_prop_100 <- (train_prop[1]/nrow(UniversalBank1))*100
validation_prop_100 <- (validation_prop[1]/nrow(UniversalBank1))*100

paste(train_prop_100,"% In Training",validation_prop_100,"% In Validation")

``` 

### a. Considering the following customer: 

> Age = 40, Experience = 10, Income = 84, Family = 2, CCAvg = 2, Education_1 = 0, Education_2 = 1, Education_3 = 0, Mortgage = 0, Securities Account = 0, CD Account = 0, Online = 1, and Credit Card = 1. 

Perform a Κ-NN Classification with all predictors except ID and ZIP code using Κ = 1 

```{r 5, echo=TRUE, results='hide'}

# Removing Some Predictors
training <- training[,-c("ID","ZIP Code")]
validation <- validation[,-c("ID","ZIP Code")]

# Target Variable As Factor
training$`Personal Loan` <- as.factor(training$`Personal Loan`) 
validation$`Personal Loan` <- as.factor(validation$`Personal Loan`) 

# Education As Factor
training$Education <- as.factor(training$Education) 
validation$Education <- as.factor(validation$Education) 

# Education One-Hot Encoding
Education_As_Dummy_Training <- model.matrix(~0+training$Education)
Education_As_Dummy_Validation <- model.matrix(~0+validation$Education)

# Append to Training and Validation Sets
training <- cbind(training,Education_As_Dummy_Training)
training <- training[,-c("Education")]

validation <- cbind(validation,Education_As_Dummy_Validation)
validation <- validation[,-c("Education")]

# Renaming Education

training = training %>% rename( Education_1 = `training$Education1` , Education_2 = `training$Education2`, Education_3 = `training$Education3`)
validation = validation %>% rename( Education_1 = `validation$Education1` , Education_2 = `validation$Education2`, Education_3 = `validation$Education3`)

# As Numeric
training$Age <- as.numeric(training$Age)
training$Experience <- as.numeric(training$Experience)
training$Income <- as.numeric(training$Income)
training$Family <- as.numeric(training$Family)
training$CCAvg <- as.numeric(training$CCAvg)
training$Mortgage <- as.numeric(training$CCAvg)

validation$Age <- as.numeric(validation$Age)
validation$Experience <- as.numeric(validation$Experience)
validation$Income <- as.numeric(validation$Income)
validation$Family <- as.numeric(validation$Family)
validation$CCAvg <- as.numeric(validation$CCAvg)
validation$Mortgage <- as.numeric(validation$CCAvg)

# Checking Structure
str(training)
str(validation)

# View Data
flextable(head(training)) %>% 
  fontsize(size = 7, part = "all")

flextable(head(validation)) %>% 
  fontsize(size = 7, part = "all")

# Duplicate Dataset Before Scaling
training_scaled <- training
validation_scaled <- validation

# Scaling 
training_scaled$Age <- scale(training_scaled$Age)
training_scaled$Experience <- scale(training_scaled$Experience)
training_scaled$Income <- scale(training_scaled$Income)
training_scaled$Family <- scale(training_scaled$Family)
training_scaled$CCAvg <- scale(training_scaled$CCAvg)
training_scaled$Mortgage <- scale(training_scaled$Mortgage)

validation_scaled$Age <- scale(validation_scaled$Age)
validation_scaled$Experience <- scale(validation_scaled$Experience)
validation_scaled$Income <- scale(validation_scaled$Income)
validation_scaled$Family <- scale(validation_scaled$Family)
validation_scaled$CCAvg <- scale(validation_scaled$CCAvg)
validation_scaled$Mortgage <- scale(validation_scaled$Mortgage)

# Table Training after Scaling
flextable(head(training_scaled)) %>% 
  fontsize(size = 7, part = "all")

# KNN Model using class package
library(class)

predictions <- knn(train=training_scaled,test = validation_scaled, cl = training_scaled$`Personal Loan`, k=1)
predictions <- as.factor(predictions)
levels(predictions) <- c("Fail","Success")

# KNN Model on a specific customer not in Data



# Append Predictions to Validation Set
validation$Predicted <- predictions

# Correct Factors of previous Validation
levels(validation$`Personal Loan`) <- c("Fail","Success")

```

<center>

```{r 6, echo=TRUE}

# Table Validation after Predictions
flextable(head(validation)) %>% 
  fontsize(size = 7, part = "all")

# Confusion Table
(Confusion_Data <- table(validation$`Personal Loan`,validation$Predicted))

```

</center>




# <span style="color: #1c6155;">Exercise 3.</span>



# <span style="color: #1c6155;">References</span>

[Github Repo for this Homework 2](https://github.com/LiamPhan17/DATA_MINING_HW2)

[Data Mining for Business Analytics: Concepts, Techniques, and Applications in R](https://www.wiley.com/en-us/Data+Mining+for+Business+Analytics:+Concepts,+Techniques,+and+Applications+in+R-p-9781118879368)

[How to Split Data into Training & Test Sets in R (3 Methods)](https://www.statology.org/train-test-split-r/)